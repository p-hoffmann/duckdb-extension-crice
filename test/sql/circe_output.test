# name: test/sql/circe_output.test
# description: validate circe_json_to_sql returns actual SQL text (not error string)
# group: [sql]

require circe

# Expect generated SQL to contain SELECT and cohort table reference (case-insensitive)
# Base64 for original JSON cohort expression
query I
WITH expr AS (
  SELECT circe_json_to_sql('ewogICJQcmltYXJ5Q3JpdGVyaWEiOiB7CiAgICAiQ3JpdGVyaWFMaXN0IjogW10sCiAgICAiT2JzZXJ2YXRpb25XaW5kb3ciOiB7IlByaW9yRGF5cyI6IDAsICJQb3N0RGF5cyI6IDB9LAogICAgIlByaW1hcnlDcml0ZXJpYUxpbWl0IjogeyJUeXBlIjogIkFsbCJ9CiAgfSwKICAiQ29uY2VwdFNldHMiOiBbXSwKICAiUXVhbGlmaWVkTGltaXQiOiB7IlR5cGUiOiAiRmlyc3QifSwKICAiRXhwcmVzc2lvbkxpbWl0IjogeyJUeXBlIjogIkFsbCJ9LAogICJJbmNsdXNpb25SdWxlcyI6IFtdCn0=', '{"cdmSchema":"cdm","resultSchema":"results","targetTable":"cohort","cohortId":42,"generateStats":false}') AS sql
)
SELECT (position('select' IN lower(sql)) > 0 AND position('cohort' IN lower(sql)) > 0)::INTEGER FROM expr;
----
1
